[marcm.test.3]
TARGET = ACCOUNT

DEFINE
 TUMIN     = "300"
 TUMAX     = "850"
 TUCODE    = "3"
 FIELDDATA = CHARACTER ARRAY(999) 
 STAGE     = CHARACTER
 CD        = NUMBER
 CDONE     = NUMBER
 QON       = NUMBER     
 CNUMBER   = NUMBER
 CDATA     = CHARACTER
 CERROR    = CHARACTER
 EOFOUND   = NUMBER
 FILETYPE  = CHARACTER
 FILENAME  = CHARACTER
 [G=NUMBER ]

 FULLNAME=CHARACTER
 REASONCODES=CHARACTER
 REDFLAGS3=CHARACTER
 REDFLAGS4=CHARACTER
 NOHIT=CHARACTER
 CDATE=CHARACTER
 TDATE=DATE
 REPORTDATE=DATE
 FNDONEACCT=CHARACTER
 FNDACCT=CHARACTER
 NN=NUMBER
 IN=NUMBER
 INACCTS=CHARACTER(10) ARRAY(500)
 A=NUMBER
 FNDSSN=CHARACTER
 TUSED=NUMBER
 DOUPDATE=CHARACTER
 NEWERDATE=DATE
 V=NUMBER
 ALOC=NUMBER ARRAY(400000)
 AACCT=CHARACTER(9) ARRAY(400000,5)
 ADATE=DATE ARRAY(400000)
 H=NUMBER
 #INCLUDE "RD.OUTPUT.DEF"
 OUTPUTCHANNEL1=NUMBER
 OUTPUTCHANNEL2=NUMBER
 ERRORTEXT=CHARACTER 
 U=NUMBER
 II=NUMBER
 STOPII=0 [SET TO 0 TO RUN ALL]
 STOPOUTPUT=CHARACTER
 RLOC=NUMBER
 RED90DAY=DATE
END 
 
SETUP
 RED90DAY=DATEOFFSET(SYSTEMDATE,3,31)
 FILETYPE="LETTER"
 FILENAME="TUIMPORT"
 FILEOPEN(FILETYPE,FILENAME,"READ",CNUMBER,CERROR)
 IF CERROR <> "" THEN
  DO
   PRINT "Error Opening File: "
   PRINT CERROR
   NEWLINE
   TERMINATE
  END
 OUTPUTOPEN(OUTPUTDEVREPORT,0,"TransUnion Import Updates","",OUTPUTCHANNEL1,ERRORTEXT)
 OUTPUTOPEN(OUTPUTDEVREPORT,0,"TransUnion Import Exceptions","",OUTPUTCHANNEL2,ERRORTEXT)
 H=1
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)  
END 

SELECT
 NONE
END

PRINT TITLE="TUIMPORT" REPORTCATEGORY="ACCOUNTRPT"
 HEADER=""
 WHILELIMIT = 100000000
 WHILE EOFOUND = 0
  DO
   CALL GETCOMMADELIMITEDRECORD
   IF EOFOUND = 0 THEN
    DO
     CALL PROCESSDATA
    END
  END
END

TOTAL
 H=2
 OUTPUTSWITCH(OUTPUTCHANNEL2,ERRORTEXT)
 NEWLINE
 COL=1 "TOTAL: "
 PRINT U
 NEWLINE
 H=1
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 NEWLINE
 COL=1 "Updated: "
 COL=22 II
 NEWLINE
 COL=1 "Exceptions: "
 COL=22 U
 NEWLINE
 COL=1 REPEATCHR("-",22)
 NEWLINE
 COL=1 "Total: "
 COL=22 II+U
 NEWLINE
 OUTPUTCLOSE(OUTPUTCHANNEL1,ERRORTEXT)
 OUTPUTCLOSE(OUTPUTCHANNEL2,ERRORTEXT)
END

PROCEDURE PROCESSDATA
[FOR G=1 TO 27
  DO
   PRINT FIELDDATA(G)
   NEWLINE
  END]
 
 FULLNAME=""
 REASONCODES=""
 REDFLAGS3=""
 REDFLAGS4=""
 NOHIT=""
 
 FULLNAME=FIELDDATA(1)
 IF FIELDDATA(2)<>"" THEN FULLNAME=FULLNAME+" "+FIELDDATA(2)
 FULLNAME=FULLNAME+" "+FIELDDATA(3)
 
 [IF SEGMENT(FULLNAME,1,13)<>"customerInput" THEN
  DO 
   COL=001 FULLNAME 
  END   
 IF SEGMENT(FIELDDATA(6),1,13)<>"customerInput" THEN
  DO 
   COL=030 FIELDDATA(6)
  END
 NEWLINE]
 
 IF LENGTH(FIELDDATA(6))<>9 OR LENGTH(FULLNAME)>40 THEN 
  CALL UPDATENEXTRUN
 ELSE 
  DO
   CDATE=SEGMENT(FIELDDATA(27),6,7)+"/"+SEGMENT(FIELDDATA(27),9,10)+"/"+SEGMENT(FIELDDATA(27),1,4)
   TDATE=DATEVALUE(CDATE)  
   IF REPORTDATE='--/--/--' THEN REPORTDATE=TDATE
   IF TDATE='--/--/--' THEN TDATE=REPORTDATE
   
   IF FIELDDATA(16)="Y" AND CHARACTERSEARCH(REDFLAGS4,"30")=0 THEN 
    REDFLAGS4=REDFLAGS4+"30," 
    
   [IF TMPCHR(14)<>"" THEN
    DO
     R=VALUE(TMPCHR(13))
     IF TMPCHR(14)="A" AND R<>6 AND CHARACTERSEARCH(REDFLAGS4,"30")=0 THEN REDFLAGS4=REDFLAGS4+"30,"
     ELSE IF TMPCHR(14)="B" AND (R=22 OR R=99) AND CHARACTERSEARCH(REDFLAGS4,"30")=0 THEN REDFLAGS4=REDFLAGS4+"30,"
     ELSE IF TMPCHR(14)="P" AND R=1 THEN NOHIT="NO HIT"
     ELSE IF TMPCHR(14)="P" AND R=2 THEN NOHIT="CONSUMER SUPPRESSION"
     ELSE IF TMPCHR(14)="S" AND R=1 AND CHARACTERSEARCH(REDFLAGS4,"03")=0 THEN REDFLAGS4=REDFLAGS4+"03,"
     ELSE IF TMPCHR(14)="S" AND R=3 AND CHARACTERSEARCH(REDFLAGS4,"24")=0 THEN REDFLAGS4=REDFLAGS4+"24,"
    END]
    
   [IF TMPCHR(18)="S" AND CHARACTERSEARCH(REDFLAGS4,"03")=0 THEN REDFLAGS4=REDFLAGS4+"03,"]
   
   IF REDFLAGS4<>"" THEN REDFLAGS4=SEGMENT(REDFLAGS4,1,LENGTH(REDFLAGS4)-1)
   
   [IF TMPCHR(23)<>"" THEN
    DO
     R=VALUE(TMPCHR(23))
     IF R=6 THEN REDFLAGS3="01"
     ELSE IF R=26 OR R=27 THEN REDFLAGS3="06"
     ELSE IF R=28 OR R=30 THEN REDFLAGS3="02"
     ELSE IF R=29 THEN REDFLAGS3="03"
     ELSE IF R=31 THEN REDFLAGS3="03,06"
    END]
    
   IF FIELDDATA(23)="Y" AND CHARACTERSEARCH(REDFLAGS3,"03")=0 THEN
    DO
     IF REDFLAGS3="" THEN REDFLAGS3="03"
     ELSE REDFLAGS3=REDFLAGS3+",03"
    END
    
   IF FIELDDATA(21)="" AND FIELDDATA(22)="" AND FIELDDATA(23)="" AND FIELDDATA(24)="" THEN 
    REASONCODES=""
   ELSE 
    DO
     REASONCODES=FORMAT("999",VALUE(FIELDDATA(21)))
     REASONCODES=REASONCODES+","+FORMAT("999",VALUE(FIELDDATA(22)))
     REASONCODES=REASONCODES+","+FORMAT("999",VALUE(FIELDDATA(23)))
     REASONCODES=REASONCODES+","+FORMAT("999",VALUE(FIELDDATA(24)))
     [IF TMPCHR(29)="08" THEN  REASONCODES=REASONCODES+","+"Y"]
    END
    
   FNDONEACCT="N"
   FNDACCT="N"
   FOR NN=1 TO IN
    DO
     INACCTS(NN)="" 
    END
   IN=0
   FOR ACCOUNT WITH SSN FIELDDATA(6)
    DO
     FNDACCT="N"
     FOR NN=1 TO IN
      DO
       IF INACCTS(NN)=ACCOUNT:NUMBER THEN FNDACCT="Y"
      END
     IF FNDACCT="N" THEN
      DO
       IN=IN+1
       INACCTS(IN)=ACCOUNT:NUMBER
      END
     A=VALUE(ACCOUNT:NUMBER)
     IF ACCOUNT:TYPE<90 AND ACCOUNT:CLOSEDATE='--/--/--' AND FNDACCT="N" THEN
      DO
       FNDSSN="N"
       FOR EACH NAME WITH NAME:EXPIRATIONDATE='--/--/--' AND NAME:SSN=FIELDDATA(6) 
        DO
         FNDSSN="Y"
        END
       IF FNDSSN="N" THEN
        DO
         FOR EACH SHARE WITH SHARE:CLOSEDATE='--/--/--'
          DO
           FOR EACH SHARE NAME WITH SHARE NAME:SSN=FIELDDATA(6) AND SHARE NAME:EXPIRATIONDATE='--/--/--'
            DO
             FNDSSN="Y"
            END
          END
        END
       IF FNDSSN="N" THEN
        DO
         FOR EACH LOAN WITH LOAN:CLOSEDATE='--/--/--'
          DO
           FOR EACH LOAN NAME WITH LOAN NAME:SSN=FIELDDATA(6) AND LOAN NAME:EXPIRATIONDATE='--/--/--'
            DO
             FNDSSN="Y"
            END
          END
        END
       IF FNDSSN="Y" THEN
        DO
         FNDONEACCT="Y"
         FNDACCT="Y"
         TUSED=0
         DOUPDATE="Y"
         NEWERDATE='--/--/--'
         V=VALUE(FIELDDATA(20))
         FOR EACH TRACKING WITH TRACKING:TYPE=31
          DO
           IF ALOC(A)=0 THEN ALOC(A)=TRACKING:LOCATOR
           IF TRACKING:USERCHAR1=FIELDDATA(6) THEN 
            DO
             IF TRACKING:USERDATE1<TDATE THEN TUSED=1
             ELSE NEWERDATE=TRACKING:USERDATE1
            END
           ELSE IF TRACKING:USERCHAR2=FIELDDATA(6) THEN 
            DO
             IF TRACKING:USERDATE2<TDATE THEN TUSED=2
             ELSE NEWERDATE=TRACKING:USERDATE2
            END
           ELSE IF TRACKING:USERCHAR3=FIELDDATA(6) THEN 
            DO
             IF TRACKING:USERDATE3<TDATE THEN TUSED=3
             ELSE NEWERDATE=TRACKING:USERDATE3
            END
           ELSE IF TRACKING:USERCHAR4=FIELDDATA(6) THEN 
            DO
             IF TRACKING:USERDATE4<TDATE THEN TUSED=4
             ELSE NEWERDATE=TRACKING:USERDATE4
            END
           ELSE IF TRACKING:USERCHAR5=FIELDDATA(6) THEN 
            DO
             IF TRACKING:USERDATE5<TDATE THEN TUSED=5
             ELSE NEWERDATE=TRACKING:USERDATE5
            END
           IF NEWERDATE<>'--/--/--' THEN CALL UPDATENEXTRUN
           ELSE
            DO
             IF TUSED=0 THEN
              DO
               IF AACCT(A,1)=FIELDDATA(6) THEN DOUPDATE="N"
               ELSE IF AACCT(A,2)=FIELDDATA(6) THEN DOUPDATE="N"
               ELSE IF AACCT(A,3)=FIELDDATA(6) THEN DOUPDATE="N"
               ELSE IF AACCT(A,4)=FIELDDATA(6) THEN DOUPDATE="N"
               ELSE IF AACCT(A,5)=FIELDDATA(6) THEN DOUPDATE="N"
               ELSE IF TRACKING:USERCHAR1="" AND AACCT(A,1)="" THEN TUSED=1
               ELSE IF TRACKING:USERCHAR2="" AND AACCT(A,2)="" THEN TUSED=2
               ELSE IF TRACKING:USERCHAR3="" AND AACCT(A,3)="" THEN TUSED=3
               ELSE IF TRACKING:USERCHAR4="" AND AACCT(A,4)="" THEN TUSED=4
               ELSE IF TRACKING:USERCHAR5="" AND AACCT(A,5)="" THEN TUSED=5
              END
             IF TUSED>0 AND DOUPDATE="Y" THEN 
              DO
               AACCT(A,TUSED)=FIELDDATA(6)
               ADATE(A)=TDATE
               IF TUSED=1 AND TRACKING:USERDATE1<TDATE THEN CALL UPDATE1
               ELSE IF TUSED=2 AND TRACKING:USERDATE2<TDATE THEN CALL UPDATE2
               ELSE IF TUSED=3 AND TRACKING:USERDATE3<TDATE THEN CALL UPDATE3
               ELSE IF TUSED=4 AND TRACKING:USERDATE4<TDATE THEN CALL UPDATE4
               ELSE IF TUSED=5 AND TRACKING:USERDATE5<TDATE THEN CALL UPDATE5
              END
            END
          END
         IF ALOC(A)=0 THEN 
          DO
           IF AACCT(A,1)=FIELDDATA(6) THEN DOUPDATE="N"
           ELSE IF AACCT(A,2)=FIELDDATA(6) THEN DOUPDATE="N"
           ELSE IF AACCT(A,3)=FIELDDATA(6) THEN DOUPDATE="N"
           ELSE IF AACCT(A,4)=FIELDDATA(6) THEN DOUPDATE="N"
           ELSE IF AACCT(A,5)=FIELDDATA(6) THEN DOUPDATE="N"
           ELSE
            DO
             IF AACCT(A,1)="" THEN TUSED=1
             ELSE IF AACCT(A,2)="" THEN TUSED=2
             ELSE IF AACCT(A,3)="" THEN TUSED=3
             ELSE IF AACCT(A,4)="" THEN TUSED=4
             ELSE IF AACCT(A,5)="" THEN TUSED=5
             AACCT(A,TUSED)=""
            END
           IF TUSED>0 AND DOUPDATE="Y" THEN CALL CREATETRACKING31
          END
         ELSE IF ALOC(A)=-1 THEN 
          DO
           IF FIELDDATA(6)<>"" THEN CALL UPDATENEXTRUN
          END
         IF REDFLAGS3<>"" OR REDFLAGS4<>"" THEN CALL ADDREDFLAGS
        END
      END
    END
   IF FNDONEACCT="N" THEN CALL UPDATENEXTRUN
  END
 FOR NN=1 TO IN
  DO
   INACCTS(NN)="" 
  END
 IN=0
         
END

PROCEDURE ADDREDFLAGS
 RLOC=0
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 FOR EACH TRACKING WITH TRACKING:TYPE=12 AND TRACKING:USERCHAR1=FIELDDATA(6)
  DO
   IF RLOC=0 THEN
    DO
     RLOC=TRACKING:LOCATOR
     IF TRACKING:EXPIREDATE='--/--/--' OR TRACKING:EXPIREDATE<RED90DAY THEN
      DO
       COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
       PRINT TRACKING:LOCATOR
       NEWLINE
       COL=2 "CHANGE USERCHAR3 FROM "
       COL=49 TRACKING:USERCHAR3
       COL=90  "TO "+REDFLAGS3
       NEWLINE
       COL=2 "CHANGE USERCHAR4 FROM "
       COL=49 TRACKING:USERCHAR4
       COL=90  "TO "+REDFLAGS4
       NEWLINE
       COL=2 "CHANGE USERDATE1 FROM "
       COL=49 FORMAT("99/99/9999",TRACKING:USERDATE1)
       COL=90  "TO --/--/--"
       NEWLINE
       COL=2 "CHANGE EXPIREDATE FROM "
       COL=49 FORMAT("99/99/9999",TRACKING:EXPIREDATE)
       COL=90  "TO "+FORMAT("99/99/99",RED90DAY)
       NEWLINE
      END
    END
  END
 IF RLOC=0 THEN
  DO
   COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" CREATE TRACKING LOC BEFOREFIRST TYPE 12"
   NEWLINE
   COL=2 "SET USERCHAR1 TO "
   COL=49 FIELDDATA(6)
   NEWLINE
   COL=2 "SET USERCHAR3 TO "
   COL=49 REDFLAGS3
   NEWLINE
   COL=2 "SET USERCHAR4 TO "
   COL=49 REDFLAGS4
   NEWLINE
   COL=2 "SET USERDATE1 TO "
   COL=49  "--/--/--"
   NEWLINE
   COL=2 "SET EXPIREDATE TO "
   COL=49 FORMAT("99/99/99",RED90DAY)
   NEWLINE
  END
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
END

PROCEDURE CREATETRACKING31
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 "0"
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>VALUE(TUMAX) THEN 
  PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN 
  STOPOUTPUT="Y"
 ALOC(A)=-1
 AACCT(A,TUSED)=FIELDDATA(6)
 ADATE(A)=TDATE
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" CREATE TRACKING LOC BEFOREFIRST TYPE 31"
 NEWLINE
 COL=2 "SET USERCHAR"+FORMAT("9",TUSED)+" TO "
 COL=49 FIELDDATA(6)
 NEWLINE 
 IF TUSED<5 THEN 
  COL=2 "SET USERCHAR"+FORMAT("9",TUSED+5)+" TO "
 ELSE 
  COL=2 "SET USERCHAR"+FORMAT("99",TUSED+5)+" TO "
 COL=49 FULLNAME
 NEWLINE
 COL=2 "SET USERCHAR"+FORMAT("99",TUSED+10)+" TO "
 COL=49 NOHIT
 NEWLINE
 COL=2 "SET USERCHAR"+FORMAT("99",TUSED+15)+" TO "
 COL=49 REASONCODES
 NEWLINE
 COL=2 "SET USERNUMBER"+FORMAT("9",TUSED)+" TO "
 PRINT FORMAT("9999",V)
 NEWLINE
 COL=2 "SET USERNUMBER"+FORMAT("99",TUSED+10)+" TO "
 PRINT TUMIN
 NEWLINE
 COL=2 "SET USERNUMBER"+FORMAT("99",TUSED+15)+" TO "
 PRINT TUMAX
 NEWLINE
 COL=2 "SET USERDATE"+FORMAT("9",TUSED)+" TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "SET USERCODE"+FORMAT("9",TUSED)+" TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TUSED<5 THEN COL=2 "SET USERCHAR"+FORMAT("9",TUSED+5)+" TO "  
 COL=2 "SET USERCODE"+FORMAT("99",TUSED+5)+" TO "
 PRINT TUCODE
 NEWLINE
 H=1
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
END

PROCEDURE UPDATE1
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 TRACKING:USERNUMBER1
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>[850]VALUE(TUMAX) THEN PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN STOPOUTPUT="Y"
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
 PRINT TRACKING:LOCATOR
 NEWLINE
 COL=2 "CHANGE USERCHAR6 FROM "
 COL=49 TRACKING:USERCHAR6
 COL=90  "TO "+FULLNAME
 NEWLINE
 IF TRACKING:USERCHAR11<>NOHIT THEN
  DO
   COL=2 "CHANGE USERCHAR11 FROM "
   COL=49 TRACKING:USERCHAR11
   COL=90  "TO "+NOHIT
   NEWLINE
  END
 IF TRACKING:USERCHAR16<>REASONCODES THEN
  DO
   COL=2 "CHANGE USERCHAR16 FROM  "
   COL=49 TRACKING:USERCHAR16
   COL=90  "TO "+REASONCODES
   NEWLINE
  END
 COL=2 "CHANGE USERNUMBER1 FROM "
 COL=49 FORMAT("9999",TRACKING:USERNUMBER1)
 COL=90 "TO "+FORMAT("9999",V)
 NEWLINE
 IF TRACKING:USERNUMBER11<>[850]VALUE(TUMAX) THEN
  DO
   COL=2 "CHANGE USERNUMBER11 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER11)
   COL=90 ["TO 850"]"TO "+TUMAX
   NEWLINE
  END
 IF TRACKING:USERNUMBER16<>[300]VALUE(TUMIN) THEN
  DO
   COL=2 "CHANGE USERNUMBER16 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER16)
   COL=90 ["TO 300"]"TO "+TUMIN
   NEWLINE
  END
 COL=2 "CHANGE USERDATE1 FROM "
 COL=49 FORMAT("99/99/99",TRACKING:USERDATE1)
 COL=90 "TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "CHANGE USERCODE1 FROM "
 COL=49 FORMAT("###9",TRACKING:USERCODE1)
 COL=90 "TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TRACKING:USERCODE6<>VALUE(TUCODE) THEN
  DO
   COL=2 "CHANGE USERCODE6 FROM "
   COL=49 FORMAT("9",TRACKING:USERCODE6)
   COL=90 "TO "+TUCODE
   NEWLINE
  END
END

PROCEDURE UPDATE2
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 TRACKING:USERNUMBER2
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>[850]VALUE(TUMAX) THEN PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN STOPOUTPUT="Y"
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
 PRINT TRACKING:LOCATOR
 NEWLINE
 COL=2 "CHANGE USERCHAR7 FROM "
 COL=49 TRACKING:USERCHAR7
 COL=90  "TO "+FULLNAME
 NEWLINE
 IF TRACKING:USERCHAR12<>NOHIT THEN
  DO
   COL=2 "CHANGE USERCHAR12 FROM "
   COL=49 TRACKING:USERCHAR12
   COL=90  "TO "+NOHIT
   NEWLINE
  END
 IF TRACKING:USERCHAR17<>REASONCODES THEN
  DO
   COL=2 "CHANGE USERCHAR17 FROM  "
   COL=49 TRACKING:USERCHAR17
   COL=90  "TO "+REASONCODES
   NEWLINE
  END
 COL=2 "CHANGE USERNUMBER2 FROM "
 COL=49 FORMAT("9999",TRACKING:USERNUMBER2)
 COL=90 "TO "+FORMAT("9999",V)
 NEWLINE
 IF TRACKING:USERNUMBER12<>[850]VALUE(TUMAX) THEN
  DO
   COL=2 "CHANGE USERNUMBER12 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER12)
   COL=90 ["TO 850"]"TO "+TUMAX
   NEWLINE
  END
 IF TRACKING:USERNUMBER17<>300 THEN
  DO
   COL=2 "CHANGE USERNUMBER17 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER17)
   COL=90 "TO 300"
   NEWLINE
  END
 COL=2 "CHANGE USERDATE2 FROM "
 COL=49 FORMAT("99/99/99",TRACKING:USERDATE2)
 COL=90 "TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "CHANGE USERCODE2 FROM "
 COL=49 FORMAT("###9",TRACKING:USERCODE2)
 COL=90 "TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TRACKING:USERCODE7<>VALUE(TUCODE) THEN
  DO
   COL=2 "CHANGE USERCODE7 FROM "
   COL=49 FORMAT("9",TRACKING:USERCODE7)
   COL=90 "TO "+TUCODE
   NEWLINE
  END
END

PROCEDURE UPDATE3
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 TRACKING:USERNUMBER3
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>[850]VALUE(TUMAX) THEN PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN STOPOUTPUT="Y"
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
 PRINT TRACKING:LOCATOR
 NEWLINE
 COL=2 "CHANGE USERCHAR8 FROM "
 COL=49 TRACKING:USERCHAR8
 COL=90  "TO "+FULLNAME
 NEWLINE
 IF TRACKING:USERCHAR13<>NOHIT THEN
  DO
   COL=2 "CHANGE USERCHAR13 FROM "
   COL=49 TRACKING:USERCHAR13
   COL=90  "TO "+NOHIT
   NEWLINE
  END
 IF TRACKING:USERCHAR18<>REASONCODES THEN
  DO
   COL=2 "CHANGE USERCHAR18 FROM  "
   COL=49 TRACKING:USERCHAR18
   COL=90  "TO "+REASONCODES
   NEWLINE
  END
 COL=2 "CHANGE USERNUMBER3 FROM "
 COL=49 FORMAT("9999",TRACKING:USERNUMBER3)
 COL=90 "TO "+FORMAT("9999",V)
 NEWLINE
 IF TRACKING:USERNUMBER13<>[850]VALUE(TUMAX) THEN
  DO
   COL=2 "CHANGE USERNUMBER13 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER13)
   COL=90 ["TO 850"]"TO "+TUMAX
   NEWLINE
  END
 IF TRACKING:USERNUMBER18<>300 THEN
  DO
   COL=2 "CHANGE USERNUMBER18 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER18)
   COL=90 "TO 300"
   NEWLINE
  END
 COL=2 "CHANGE USERDATE3 FROM "
 COL=49 FORMAT("99/99/99",TRACKING:USERDATE3)
 COL=90 "TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "CHANGE USERCODE3 FROM "
 COL=49 FORMAT("###9",TRACKING:USERCODE3)
 COL=90 "TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TRACKING:USERCODE8<>VALUE(TUCODE) THEN
  DO
   COL=2 "CHANGE USERCODE8 FROM "
   COL=49 FORMAT("9",TRACKING:USERCODE8)
   COL=90 "TO "+TUCODE
   NEWLINE
  END
END

PROCEDURE UPDATE4
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 TRACKING:USERNUMBER4
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>[850]VALUE(TUMAX) THEN PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN STOPOUTPUT="Y"
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
 PRINT TRACKING:LOCATOR
 NEWLINE
 COL=2 "CHANGE USERCHAR9 FROM "
 COL=49 TRACKING:USERCHAR9
 COL=90  "TO "+FULLNAME
 NEWLINE
 IF TRACKING:USERCHAR14<>NOHIT THEN
  DO
   COL=2 "CHANGE USERCHAR14 FROM "
   COL=49 TRACKING:USERCHAR14
   COL=90  "TO "+NOHIT
   NEWLINE
  END
 IF TRACKING:USERCHAR19<>REASONCODES THEN
  DO
   COL=2 "CHANGE USERCHAR19 FROM  "
   COL=49 TRACKING:USERCHAR19
   COL=90  "TO "+REASONCODES
   NEWLINE
  END
 COL=2 "CHANGE USERNUMBER4 FROM "
 COL=49 FORMAT("9999",TRACKING:USERNUMBER4)
 COL=90 "TO "+FORMAT("9999",V)
 NEWLINE
 IF TRACKING:USERNUMBER14<>[850]VALUE(TUMAX) THEN
  DO
   COL=2 "CHANGE USERNUMBER14 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER14)
   COL=90 ["TO 850"]"TO "+TUMAX
   NEWLINE
  END
 IF TRACKING:USERNUMBER19<>300 THEN
  DO
   COL=2 "CHANGE USERNUMBER19 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER19)
   COL=90 "TO 300"
   NEWLINE
  END
 COL=2 "CHANGE USERDATE4 FROM "
 COL=49 FORMAT("99/99/99",TRACKING:USERDATE4)
 COL=90 "TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "CHANGE USERCODE4 FROM "
 COL=49 FORMAT("###9",TRACKING:USERCODE4)
 COL=90 "TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TRACKING:USERCODE9<>VALUE(TUCODE) THEN
  DO
   COL=2 "CHANGE USERCODE9 FROM "
   COL=49 FORMAT("9",TRACKING:USERCODE9)
   COL=90 "TO "+TUCODE
   NEWLINE
  END
END

PROCEDURE UPDATE5
 OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
 COL=1 ACCOUNT:NUMBER
 COL=12 FULLNAME
 COL=71 FIELDDATA(6)
 COL=83 TRACKING:USERNUMBER5
 COL=86 FORMAT("9999",V)
 IF VALUE(FIELDDATA(20))>[850]VALUE(TUMAX) THEN PRINT " - "+FIELDDATA(20)
 NEWLINE
 II=II+1
 IF STOPII>0 AND II>STOPII THEN STOPOUTPUT="Y"
 H=3
 OUTPUTSWITCH(OUTPUTCHANNEL1,ERRORTEXT)
 COL=1 "ACCOUNT "+ACCOUNT:NUMBER+" MODIFY TRACKING LOC "
 PRINT TRACKING:LOCATOR
 NEWLINE
 COL=2 "CHANGE USERCHAR10 FROM "
 COL=49 TRACKING:USERCHAR10
 COL=90  "TO "+FULLNAME
 NEWLINE
 IF TRACKING:USERCHAR15<>NOHIT THEN
  DO
   COL=2 "CHANGE USERCHAR15 FROM "
   COL=49 TRACKING:USERCHAR15
   COL=90  "TO "+NOHIT
   NEWLINE
  END
 IF TRACKING:USERCHAR20<>REASONCODES THEN
  DO
   COL=2 "CHANGE USERCHAR20 FROM  "
   COL=49 TRACKING:USERCHAR20
   COL=90  "TO "+REASONCODES
   NEWLINE
  END
 COL=2 "CHANGE USERNUMBER5 FROM "
 COL=49 FORMAT("9999",TRACKING:USERNUMBER5)
 COL=90 "TO "+FORMAT("9999",V)
 NEWLINE
 IF TRACKING:USERNUMBER15<>[850]VALUE(TUMAX) THEN
  DO
   COL=2 "CHANGE USERNUMBER15 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER15)
   COL=90 ["TO 850"]"TO "+TUMAX
   NEWLINE
  END
 IF TRACKING:USERNUMBER19<>300 THEN
  DO
   COL=2 "CHANGE USERNUMBER20 FROM "
   COL=49 FORMAT("999",TRACKING:USERNUMBER20)
   COL=90 "TO 300"
   NEWLINE
  END
 COL=2 "CHANGE USERDATE5 FROM "
 COL=49 FORMAT("99/99/99",TRACKING:USERDATE5)
 COL=90 "TO "+FORMAT("99/99/99",TDATE)
 NEWLINE
 COL=2 "CHANGE USERCODE5 FROM "
 COL=49 FORMAT("###9",TRACKING:USERCODE5)
 COL=90 "TO "+FORMAT("###9",SYSACTUALTIME)
 NEWLINE
 IF TRACKING:USERCODE10<>VALUE(TUCODE) THEN
  DO
   COL=2 "CHANGE USERCODE10 FROM "
   COL=49 FORMAT("9",TRACKING:USERCODE10)
   COL=90 "TO "+TUCODE
   NEWLINE
  END
END

PROCEDURE UPDATENEXTRUN
 IF NEWERDATE<>REPORTDATE THEN
  DO
   H=2
   OUTPUTSWITCH(OUTPUTCHANNEL2,ERRORTEXT)
   COL=1 FORMAT("9999999999",A)
   COL=12 FIELDDATA(6)
   COL=35 SEGMENT(FULLNAME,1,35)
   IF FNDACCT="N" THEN COL=75 "No Open Account found"
   ELSE 
    DO
     IF NEWERDATE<>'--/--/--' THEN 
      COL=75 "Score on Tracking is Newer "+FORMAT("99/99/99",NEWERDATE)
     ELSE IF LENGTH(FULLNAME)>40 THEN COL=75 "Name too long "+SEGMENT(FULLNAME,1,60)
     ELSE COL=75 "WILL UPDATE NEXT RUN"
    END
   NEWLINE
   U=U+1
   H=1
   OUTPUTSWITCH(OUTPUTCHANNELDEFAULT,ERRORTEXT)
  END
END


PROCEDURE GETCOMMADELIMITEDRECORD
 FOR CD = 0 TO 999
  DO
   FIELDDATA(CD) = ""
  END

 CDONE = 0
 CD = 0
 WHILE CDONE = 0 AND EOFOUND = 0
  DO
   CALL READDATA
   IF EOFOUND = 0 THEN
    DO
     IF CDATA = CTRLCHR(10) OR             [Newline]              [End of Record]
        CDATA = CTRLCHR(12) OR             [Form Feed]
        CDATA = CTRLCHR(13) THEN           [Carrage Return]
      DO
       IF CD > 0 THEN                      [Skip extra Line Feeds]
        DO
         CDONE = 1
         CD = CD + 1            
         FIELDDATA(CD) = STAGE      
         STAGE = ""
        END                 
      END
     ELSE IF CDATA = "," AND               [End of Field]
               QON = 0 THEN                [Not inside Quotes] 
      DO
       CD = CD + 1            
       FIELDDATA(CD) = STAGE
       STAGE = ""
      END
     ELSE IF CDATA = CTRLCHR(34) THEN      [Quote]
      DO
       IF QON = 0 THEN
        QON = 1
       ELSE
        QON = 0
      END 
     ELSE
      DO
       STAGE = STAGE + CDATA
      END
    END
  END
END

PROCEDURE READDATA
 FILEREAD(CNUMBER,1,CDATA,CERROR)
 IF CERROR = "EOF" THEN
  DO
   EOFOUND = 1
   FILECLOSE(CNUMBER,CERROR)
  END
 ELSE IF CERROR <> "" THEN
  DO
   PRINT "Error Reading Comma Delimited File = "+CERROR
   NEWLINE
   TERMINATE
  END
END
